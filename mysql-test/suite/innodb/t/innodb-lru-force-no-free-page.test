--source include/have_innodb.inc
--source include/have_debug.inc
--source include/no_valgrind_without_big.inc
--source include/not_embedded.inc
--source include/big_test.inc
# The test case currently uses grep, which may be unavailable on
# some windows systems. But see MWL#191 for how to remove the need for grep.
--source include/not_windows.inc

call mtr.add_suppression("\\[Warning\\] InnoDB: Difficult to find free blocks in the buffer pool.*");

let $comp = `SELECT @@innodb_compression_level`;
SET GLOBAL innodb_compression_level=0;
SELECT @@innodb_compression_level;

SET SESSION debug_dbug="+d,ib_lru_force_no_free_page";

CREATE TABLE t1 (j LONGBLOB) ENGINE = InnoDB ROW_FORMAT=COMPRESSED KEY_BLOCK_SIZE=1;
BEGIN;
INSERT INTO t1 VALUES (repeat('abcdefghijklmnopqrstuvwxyz',200));
let $i=3;
while ($i > 0) {
  INSERT INTO t1 SELECT * from t1;
  dec $i;
}
COMMIT;

SET SESSION debug_dbug="";

DROP TABLE t1;

#
# There should be only one message
#
let SEARCH_RANGE= -50000;
let SEARCH_FILE= $MYSQLTEST_VARDIR/log/mysqld.1.err;
--let SEARCH_PATTERN=InnoDB: Difficult to find free blocks 
--source include/search_pattern_in_file.inc

eval set GLOBAL innodb_compression_level=$comp;
