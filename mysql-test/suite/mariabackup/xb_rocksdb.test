if (`SELECT COUNT(*) = 0 FROM INFORMATION_SCHEMA.PLUGINS WHERE PLUGIN_NAME = 'rocksdb'`)
{
  --skip Requires rocksdb
}


CREATE TABLE t(i INT) ENGINE ROCKSDB;
INSERT INTO t VALUES(1);
echo # xtrabackup backup;
let $targetdir=$MYSQLTEST_VARDIR/tmp/backup;
let $stream=$MYSQLTEST_VARDIR/tmp/backup.xb;
--disable_result_log
exec $XTRABACKUP --defaults-file=$MYSQLTEST_VARDIR/my.cnf --backup --target-dir=$targetdir;
--enable_result_log

INSERT INTO t VALUES(2);


echo # xtrabackup prepare;
--disable_result_log
exec $XTRABACKUP  --prepare --target-dir=$targetdir;
-- source include/restart_and_restore.inc
--enable_result_log

SELECT * FROM t;

rmdir $targetdir;
mkdir $targetdir;


echo # xtrabackup backup to stream;
exec $XTRABACKUP --defaults-file=$MYSQLTEST_VARDIR/my.cnf  --backup  --stream=xbstream > $stream 2>$targetdir/backup_stream.log;

echo # xbstream extract;

exec $XBSTREAM -x -C $targetdir  < $stream;

echo # xtrabackup prepare;
--disable_result_log
exec $XTRABACKUP --prepare --target-dir=$targetdir;

-- source include/restart_and_restore.inc
--enable_result_log
SELECT * FROM t;

DROP TABLE t;
rmdir $targetdir;
